<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Scrolling Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1d29;
            color: #e1e4ea;
        }
        
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4a9eff;
            margin-bottom: 20px;
        }
        
        .status-panel {
            background: #282c3c;
            border: 1px solid #3f4458;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            padding: 10px;
            background: #1a1d29;
            border-radius: 4px;
            border: 1px solid #3f4458;
        }
        
        .status-label {
            font-size: 12px;
            color: #8b92a9;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #4a9eff;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #3d8ae5;
        }
        
        button.secondary {
            background: #3f4458;
        }
        
        button.secondary:hover {
            background: #4a5063;
        }
        
        .success {
            color: #22c55e;
        }
        
        .error {
            color: #ef4444;
        }
        
        .warning {
            color: #f59e0b;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #3f4458;
            border-radius: 8px;
            background: white;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-panel {
            border: 1px solid #3f4458;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .comparison-header {
            background: #282c3c;
            padding: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: normal;
        }
        
        .badge.active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }
        
        .badge.inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ”§ Virtual Scrolling Fix Verification</h1>
        
        <div class="status-panel">
            <h2>Test Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Virtual Scrolling</div>
                    <div class="status-value" id="virtual-status">Checking...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Messages Rendered</div>
                    <div class="status-value" id="message-count">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Overlap Issues</div>
                    <div class="status-value" id="overlap-status">Testing...</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Keyboard Events</div>
                    <div class="status-value" id="keyboard-status">Testing...</div>
                </div>
            </div>
        </div>
        
        <div class="test-controls">
            <button onclick="toggleVirtualScrolling()">Toggle Virtual Scrolling</button>
            <button onclick="testKeyboardNavigation()">Test Keyboard Navigation</button>
            <button onclick="testScrollPerformance()">Test Scroll Performance</button>
            <button onclick="checkOverlap()" class="secondary">Check for Overlaps</button>
            <button onclick="location.reload()" class="secondary">Reload Page</button>
        </div>
        
        <div class="comparison-grid">
            <div class="comparison-panel">
                <div class="comparison-header">
                    <span>Virtual Scrolling</span>
                    <span class="badge" id="virtual-badge">Loading...</span>
                </div>
                <iframe id="app-frame-virtual" src="http://localhost:1420"></iframe>
            </div>
            <div class="comparison-panel">
                <div class="comparison-header">
                    <span>Regular Scrolling</span>
                    <span class="badge inactive">OFF</span>
                </div>
                <iframe id="app-frame-regular" src="http://localhost:1420"></iframe>
            </div>
        </div>
    </div>
    
    <script>
        let virtualEnabled = false;
        
        async function checkVirtualStatus() {
            try {
                const frame = document.getElementById('app-frame-virtual');
                const win = frame.contentWindow;
                
                // Wait for app to load
                await new Promise(resolve => {
                    if (frame.contentDocument.readyState === 'complete') {
                        resolve();
                    } else {
                        frame.onload = resolve;
                    }
                });
                
                // Check if virtual scrolling is enabled
                setTimeout(() => {
                    const virtualBadge = win.document.querySelector('.virtual-badge');
                    virtualEnabled = !!virtualBadge;
                    
                    document.getElementById('virtual-status').textContent = virtualEnabled ? 'ENABLED' : 'DISABLED';
                    document.getElementById('virtual-status').className = virtualEnabled ? 'success' : 'warning';
                    
                    const badge = document.getElementById('virtual-badge');
                    badge.textContent = virtualEnabled ? 'ON' : 'OFF';
                    badge.className = 'badge ' + (virtualEnabled ? 'active' : 'inactive');
                    
                    // Count messages
                    const messages = win.document.querySelectorAll('.message-item');
                    document.getElementById('message-count').textContent = messages.length;
                    
                    // Check for overlaps
                    checkOverlap();
                }, 2000);
            } catch (error) {
                console.error('Error checking virtual status:', error);
                document.getElementById('virtual-status').textContent = 'ERROR';
                document.getElementById('virtual-status').className = 'error';
            }
        }
        
        function checkOverlap() {
            try {
                const frame = document.getElementById('app-frame-virtual');
                const win = frame.contentWindow;
                const messages = win.document.querySelectorAll('.virtual-item');
                
                let overlaps = 0;
                const positions = [];
                
                messages.forEach((msg, i) => {
                    const rect = msg.getBoundingClientRect();
                    positions.push({
                        index: i,
                        top: rect.top,
                        bottom: rect.bottom,
                        height: rect.height
                    });
                });
                
                // Check for overlaps
                for (let i = 0; i < positions.length - 1; i++) {
                    const current = positions[i];
                    const next = positions[i + 1];
                    
                    if (current.bottom > next.top + 5) { // 5px tolerance
                        overlaps++;
                        console.warn(`Overlap detected between message ${i} and ${i + 1}`);
                    }
                }
                
                const overlapStatus = document.getElementById('overlap-status');
                if (overlaps === 0) {
                    overlapStatus.textContent = 'NONE DETECTED';
                    overlapStatus.className = 'success';
                } else {
                    overlapStatus.textContent = `${overlaps} FOUND`;
                    overlapStatus.className = 'error';
                }
                
                return overlaps === 0;
            } catch (error) {
                console.error('Error checking overlap:', error);
                document.getElementById('overlap-status').textContent = 'CHECK FAILED';
                document.getElementById('overlap-status').className = 'error';
                return false;
            }
        }
        
        async function toggleVirtualScrolling() {
            try {
                const frame = document.getElementById('app-frame-virtual');
                const win = frame.contentWindow;
                
                // Find and click the performance settings button
                const settingsBtn = win.document.querySelector('[title*="Performance"]');
                if (settingsBtn) {
                    settingsBtn.click();
                    
                    setTimeout(() => {
                        const toggle = win.document.querySelector('input[type="checkbox"]');
                        if (toggle) {
                            toggle.click();
                            setTimeout(() => {
                                checkVirtualStatus();
                            }, 1000);
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Error toggling virtual scrolling:', error);
            }
        }
        
        async function testKeyboardNavigation() {
            try {
                const frame = document.getElementById('app-frame-virtual');
                const win = frame.contentWindow;
                
                // Focus the result list
                const resultList = win.document.querySelector('.result-list');
                if (resultList) {
                    resultList.focus();
                    
                    // Simulate arrow down key
                    const event = new KeyboardEvent('keydown', {
                        key: 'ArrowDown',
                        code: 'ArrowDown',
                        bubbles: true
                    });
                    
                    resultList.dispatchEvent(event);
                    
                    setTimeout(() => {
                        const focused = win.document.querySelector('.message-item.focused');
                        const keyboardStatus = document.getElementById('keyboard-status');
                        
                        if (focused) {
                            keyboardStatus.textContent = 'WORKING';
                            keyboardStatus.className = 'success';
                        } else {
                            keyboardStatus.textContent = 'NOT WORKING';
                            keyboardStatus.className = 'error';
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Error testing keyboard:', error);
                document.getElementById('keyboard-status').textContent = 'TEST FAILED';
                document.getElementById('keyboard-status').className = 'error';
            }
        }
        
        async function testScrollPerformance() {
            try {
                const frame = document.getElementById('app-frame-virtual');
                const win = frame.contentWindow;
                const scrollContainer = win.document.querySelector('.messages');
                
                if (!scrollContainer) {
                    alert('No scroll container found');
                    return;
                }
                
                const startTime = performance.now();
                let frames = 0;
                const duration = 2000; // 2 seconds
                
                const animate = () => {
                    scrollContainer.scrollTop = Math.sin(frames * 0.05) * (scrollContainer.scrollHeight / 2) + (scrollContainer.scrollHeight / 2);
                    frames++;
                    
                    if (performance.now() - startTime < duration) {
                        requestAnimationFrame(animate);
                    } else {
                        const fps = (frames / (duration / 1000)).toFixed(2);
                        alert(`Scroll Performance: ${fps} FPS\n${fps > 30 ? 'Good performance!' : 'Performance needs improvement'}`);
                    }
                };
                
                requestAnimationFrame(animate);
            } catch (error) {
                console.error('Error testing scroll performance:', error);
                alert('Scroll performance test failed');
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            checkVirtualStatus();
            
            // Also set up the regular scrolling frame to disable virtual
            const regularFrame = document.getElementById('app-frame-regular');
            regularFrame.onload = () => {
                setTimeout(() => {
                    try {
                        const win = regularFrame.contentWindow;
                        // Attempt to disable virtual scrolling in this frame
                        // This would require the app to support URL parameters or localStorage
                        console.log('Regular scrolling frame loaded');
                    } catch (error) {
                        console.error('Error setting up regular frame:', error);
                    }
                }, 2000);
            };
        });
    </script>
</body>
</html>
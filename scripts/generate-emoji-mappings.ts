#!/usr/bin/env node
/**
 * Generate STANDARD_EMOJIS from Slack's official emoji mapping data
 *
 * This script converts HTML entity format (&#xXXXX;) to Unicode characters
 * and generates a TypeScript constant that can be used in emojiService.ts
 */

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

// ESM equivalent of __dirname
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// HTMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’Unicodeã«å¤‰æ›
function htmlEntityToEmoji(entity: string): string {
  // &#x1F375; ã®ã‚ˆã†ãªå½¢å¼ã‹ã‚‰ ğŸµ ã«å¤‰æ›
  const hexCode = entity.replace('&#x', '').replace(';', '');

  // è¤‡æ•°ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚µãƒãƒ¼ãƒˆï¼ˆZWJçµµæ–‡å­—ãªã©ï¼‰
  const codes = hexCode.split('-').map(code => parseInt(code, 16));

  return String.fromCodePoint(...codes);
}

async function generateEmojiMappings() {
  console.log('ğŸš€ Starting emoji mapping generation...\n');

  // å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
  const inputPath = path.join(__dirname, 'slack_emoji_mapping.json');
  console.log(`ğŸ“‚ Reading: ${inputPath}`);

  const rawData = fs.readFileSync(inputPath, 'utf8');
  const slackMapping = JSON.parse(rawData);

  console.log(`âœ… Loaded ${Object.keys(slackMapping).length} emoji mappings\n`);

  // STANDARD_EMOJISã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
  const standardEmojis: Record<string, string> = {};
  let successCount = 0;
  let errorCount = 0;

  for (const [name, htmlEntity] of Object.entries(slackMapping)) {
    try {
      standardEmojis[name] = htmlEntityToEmoji(htmlEntity as string);
      successCount++;
    } catch (error) {
      console.error(`âŒ Failed to convert: ${name} = ${htmlEntity}`);
      errorCount++;
    }
  }

  console.log(`âœ… Successfully converted: ${successCount} emojis`);
  if (errorCount > 0) {
    console.log(`âš ï¸  Failed to convert: ${errorCount} emojis`);
  }
  console.log();

  // TypeScriptã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å‡ºåŠ›
  const output = `/**
 * Auto-generated from Slack's official emoji mapping data
 * Source: https://gist.github.com/nickgrealy/f3f27874d306a5d5048f02f0d3e14c07
 *
 * DO NOT EDIT THIS FILE MANUALLY
 * To regenerate, run: npm run generate-emojis
 */

export const STANDARD_EMOJIS: Record<string, string> = ${JSON.stringify(standardEmojis, null, 2)};
`;

  // å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€
  const outputPath = path.join(__dirname, '..', 'src', 'lib', 'services', 'generatedEmojis.ts');
  console.log(`ğŸ’¾ Writing to: ${outputPath}`);

  fs.writeFileSync(outputPath, output, 'utf8');

  console.log(`âœ… Generated ${Object.keys(standardEmojis).length} emoji mappings`);
  console.log(`ğŸ“¦ File size: ${(fs.statSync(outputPath).size / 1024).toFixed(2)} KB`);
  console.log('\nğŸ‰ Done!');
}

// å®Ÿè¡Œ
generateEmojiMappings().catch(error => {
  console.error('âŒ Error:', error);
  process.exit(1);
});
